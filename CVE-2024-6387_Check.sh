#!/bin/bash

# Array of vulnerable and excluded SSH versions
vulnerable_versions=(
    'SSH-2.0-OpenSSH_8.5'
    'SSH-2.0-OpenSSH_8.6'
    'SSH-2.0-OpenSSH_8.7'
    'SSH-2.0-OpenSSH_8.8'
    'SSH-2.0-OpenSSH_8.9'
    'SSH-2.0-OpenSSH_9.0'
    'SSH-2.0-OpenSSH_9.1'
    'SSH-2.0-OpenSSH_9.2'
    'SSH-2.0-OpenSSH_9.3'
    'SSH-2.0-OpenSSH_9.4'
    'SSH-2.0-OpenSSH_9.5'
    'SSH-2.0-OpenSSH_9.6'
    'SSH-2.0-OpenSSH_9.7'
)

excluded_versions=(
    'SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.10'
    'SSH-2.0-OpenSSH_9.3p1 Ubuntu-3ubuntu3.6'
    'SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.3'
    'SSH-2.0-OpenSSH_9.2p1 Debian-2+deb12u3'
    'SSH-2.0-OpenSSH_8.4p1 Debian-5+deb11u3'
)

# Perform Nmap scan on port 22 for each domain in domains.txt
nmap_scan() {
    while IFS= read -r domain; do
        nmap -p 22 --open --max-retries 1 --host-timeout 5s "$domain" -oG - | grep '22/open' | awk '{print $2,$3,$5}'
    done < "domains.txt"
}

# Main script logic
main() {
    echo "Performing Nmap scan on domains listed in domains.txt..."
    while IFS= read -r line; do
        ssh_version=$(echo "$line" | awk '{print $2}')
        domain=$(echo "$line" | awk '{print $3}')
        ip=$(echo "$line" | awk '{print $1}')

        # Check if the SSH version is in vulnerable_versions and not in excluded_versions
        if [[ " ${vulnerable_versions[@]} " =~ " ${ssh_version} " && ! " ${excluded_versions[@]} " =~ " ${ssh_version} " ]]; then
            echo "Vulnerable SSH version found:"
            echo "  Domain: $domain"
            echo "  IP: $ip"
            echo "  SSH Version: $ssh_version"
        fi
    done < <(nmap_scan)
}

# Run the main function
main
